Generic single-database configuration.



alembic revision --autogenerate -m "add owner_id to milk tables"
alembic upgrade head
alembic current
alembic history
alembic downgrade -1   ---      Rollback if mistake:


ğŸ“ Expected Backend Structure (Your Case)
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ database.py
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â””â”€â”€ config.py
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ users.py
â”‚   â”‚   â”œâ”€â”€ milk_intake.py
â”‚   â”‚   â”œâ”€â”€ milk_sales.py
â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â””â”€â”€ routers/
â”œâ”€â”€ alembic/
â”‚   â”œâ”€â”€ versions/
â”‚   â””â”€â”€ env.py
â”œâ”€â”€ alembic.ini
â””â”€â”€ requirements.txt

ğŸ§± STEP 1: Install Alembic

Activate virtual env first ğŸ‘‡

pip install alembic


Add to requirements.txt:

alembic

ğŸ§± STEP 2: Initialize Alembic (One Time)

Run from backend root:

alembic init alembic


Creates:

alembic/
alembic.ini

ğŸ§± STEP 3: Centralize DB URL (IMPORTANT)
app/core/config.py
import os

DATABASE_URL = os.getenv(
    "DATABASE_URL",
    "postgresql+psycopg2://postgres:password@localhost:5432/milk_db"
)

app/database.py
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, declarative_base
from app.core.config import DATABASE_URL

engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(bind=engine)

Base = declarative_base()


ğŸš« Do NOT use Base.metadata.create_all() anymore

ğŸ§± STEP 4: Wire Alembic to Your Models
alembic/env.py (MOST IMPORTANT FILE)

Replace content with this safe version ğŸ‘‡

from logging.config import fileConfig
from sqlalchemy import engine_from_config, pool
from alembic import context

from app.database import Base
from app.core.config import DATABASE_URL

# Import ALL models here
from app.models import users, milk_intake, milk_sales

config = context.config
config.set_main_option("sqlalchemy.url", DATABASE_URL)

if config.config_file_name:
    fileConfig(config.config_file_name)

target_metadata = Base.metadata


def run_migrations_offline():
    context.configure(
        url=DATABASE_URL,
        target_metadata=target_metadata,
        literal_binds=True,
        compare_type=True
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online():
    connectable = engine_from_config(
        config.get_section(config.config_ini_section),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata,
            compare_type=True
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()

ğŸ§± STEP 5: Register Models (CRITICAL)
app/models/__init__.py
from .users import User
from .milk_intake import MilkIntake
from .milk_sales import MilkSale


Without this â†’ Alembic wonâ€™t detect changes âŒ

ğŸ§± STEP 6: First Migration (Baseline)

If DB already exists:

alembic revision --autogenerate -m "baseline schema"


Then:

alembic upgrade head


This syncs DB to current models.